
pipeline {
    agent any
 
    tools {
        // Install the Maven version configured as "M3" and add it to the path.
        maven "M2_HOME"
    }
 
    stages {
        stage('GIT Checkout'){
            steps{
            git branch: 'khalil_hajji',
            url : 'https://github.com/romdhanikhalil16/achat.git'
            }
            }
            stage('BUILD') {
            steps {
                sh 'mvn clean'
                sh 'mvn compile'
                sh 'mvn install'
            }
        }
        stage('MVN SONARQUBE') {
            steps {
                sh 'mvn sonar:sonar -Dsonar.login=admin -Dsonar.password=sonar'
            }
        }
        stage('MOCKITO') {
            steps {
                sh 'mvn test'
            }
        }
 
        stage('NEXUS') {
            steps {
                sh 'mvn deploy'
            }
        }
         stage('Building IMAGE') {
            steps {
                sh 'docker build -t khajji/achat-devops:1.0.0 .'
            }
        }
        stage('Deploy IMAGE') {
            steps {
                sh 'docker login -u khajji -p khalilhajji'
                sh 'docker push khajji/achat-devops:1.0.0'
 
             }
         }
        stage('Docker Compose') {
            steps {
                echo 'composing docker image...';
                sh 'docker-compose up -d'
             }
         }
        stage('Prometheus') {
            steps {
                script {
                    sh 'curl -X POST -d "status=success" http://localhost:9090/metrics/job/prometheus_stage'
                }
            }
        }

        stage('Grafana') {
            steps {
                script {
                    sh 'curl -X POST -d "prometheus_url=http://localhost:9090/" -d "grafana_url=http://localhost:3000/" http://localhost:8080/api/datasources'

                        }
                 }
            }
 
 
    }
}